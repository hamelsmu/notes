<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<link rel="search" type="application/opensearchdescription+xml" title="Hamel&#39;s Notes" href="/opensearch.xml"><title data-rh="true">2_Computer_Vision | Hamel&#x27;s Notes</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://notes.hamel.dev/fastai/cv"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="2_Computer_Vision | Hamel&#x27;s Notes"><meta data-rh="true" name="description" content="Data Prep"><meta data-rh="true" property="og:description" content="Data Prep"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://notes.hamel.dev/fastai/cv"><link data-rh="true" rel="alternate" href="https://notes.hamel.dev/fastai/cv" hreflang="en"><link data-rh="true" rel="alternate" href="https://notes.hamel.dev/fastai/cv" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://N4X7RUH2CX-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.04cdaf53.css">
<link rel="preload" href="/assets/js/runtime~main.8d0bccbc.js" as="script">
<link rel="preload" href="/assets/js/main.f7695f3c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Notes</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleChecked_cnQY toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" checked="" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently dark mode)"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Hamel&#x27;s Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/concurrency">Python Concurrency</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/actions/">actions</a><button aria-label="Toggle the collapsible sidebar category &#x27;actions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/fastai/fundamentals">fastai</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/fastai/fundamentals">1_Fundamentals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/fastai/cv">2_Computer_Vision</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/fastai/batch_predicitions">Batch Predictions</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docker/Docker-In-Action">docker</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/jupyter/remote_browser">jupyter</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/how-to-learn/lhtl">how-to-learn</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/linux/">linux</a><button aria-label="Toggle the collapsible sidebar category &#x27;linux&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/programming-languages/pl">programming-languages</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">fastai</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/fastai/cv">2_Computer_Vision</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Image Classification</h1><div class="tableOfContentsInline_gwOO"><ul class="table-of-contents"><li><a href="#data-prep">Data Prep</a><ul><li><a href="#debugging">Debugging</a></li><li><a href="#example-of-an-error-in-data-prep">Example of an error in data prep</a></li></ul></li><li><a href="#interpretation">Interpretation</a></li><li><a href="#improving-the-model">Improving the model</a><ul><li><a href="#learning-rate-finder">Learning Rate Finder</a></li><li><a href="#fine-tuning-models">Fine Tuning models</a></li><li><a href="#discriminative-learning-rates">Discriminative Learning Rates</a></li></ul></li><li><a href="#mixed-precision-training">Mixed Precision Training</a></li></ul></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="data-prep">Data Prep<a class="hash-link" href="#data-prep" title="Direct link to heading">â€‹</a></h2><p>Remember, <code>Datablock</code> helps create <code>DataLoaders</code>.  </p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> fastai</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">vision</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token builtin" style="color:rgb(189, 147, 249)">all</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">path </span><span class="token operator">=</span><span class="token plain"> untar_data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">URLs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">PETS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pets </span><span class="token operator">=</span><span class="token plain"> DataBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">blocks </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ImageBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> CategoryBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 get_items</span><span class="token operator">=</span><span class="token plain">get_image_files</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 splitter</span><span class="token operator">=</span><span class="token plain">RandomSplitter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">seed</span><span class="token operator">=</span><span class="token number">42</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 get_y</span><span class="token operator">=</span><span class="token plain">using_attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RegexLabeller</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">r&#x27;(.+)_\d+.jpg$&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;name&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 item_tfms</span><span class="token operator">=</span><span class="token plain">Resize</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">460</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 batch_tfms</span><span class="token operator">=</span><span class="token plain">aug_transforms</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">size</span><span class="token operator">=</span><span class="token number">224</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> min_scale</span><span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="debugging">Debugging<a class="hash-link" href="#debugging" title="Direct link to heading">â€‹</a></h3><p>You can debug the Datablock by calling .summary(), which will show you if you have any errors.</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pets</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">summary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token operator">/</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;images&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If everything looks good, you can use the DataBlock to create a <code>DataLoaders</code> instance:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">dls </span><span class="token operator">=</span><span class="token plain"> pets</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">dataloaders</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token operator">/</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;images&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Once you have a <code>DataLoaders</code> instance, it is a good idea to call <code>show_batch</code> to spot check that things look reasonable:</p><p>You can debug this by using <code>show_batch</code>:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> dls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">show_batch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">nrows</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> ncols</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">shows images</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Finally, you can see what a batch looks like by calling <code>dls.one_batch()</code></p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">y </span><span class="token operator">=</span><span class="token plain"> dls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">one_batch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You always want to train a model ASAP as your final debugging step.  If you wait too long, you will not discover problems</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn </span><span class="token operator">=</span><span class="token plain"> cnn_learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resnet34</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> metrics</span><span class="token operator">=</span><span class="token plain">error_rate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fine_tune</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="example-of-an-error-in-data-prep">Example of an error in data prep<a class="hash-link" href="#example-of-an-error-in-data-prep" title="Direct link to heading">â€‹</a></h3><p>A common error is forgetting to use <code>Resize</code> in your DataBlock as an item transform.  For example, the below code will cause an error:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pets1 </span><span class="token operator">=</span><span class="token plain"> DataBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">blocks </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">ImageBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> CategoryBlock</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 get_items</span><span class="token operator">=</span><span class="token plain">get_image_files</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 splitter</span><span class="token operator">=</span><span class="token plain">RandomSplitter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">seed</span><span class="token operator">=</span><span class="token number">42</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 </span><span class="token comment" style="color:rgb(98, 114, 164)">#forgot to pass `item_tfms=Resize(...),`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                 get_y</span><span class="token operator">=</span><span class="token plain">using_attr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">RegexLabeller</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">r&#x27;(.+)_\d+.jpg$&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;name&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pets1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">summary</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token operator">/</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;images&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This will complain that it is not able to collate the images because they are of different sizes.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="interpretation">Interpretation<a class="hash-link" href="#interpretation" title="Direct link to heading">â€‹</a></h2><p>You can get diagnostics for your model using this:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">interp </span><span class="token operator">=</span><span class="token plain"> ClassificationInterpretation</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">from_learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">interp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">plot_confusion_matrix</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">figsize</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">12</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token number">12</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> dpi</span><span class="token operator">=</span><span class="token number">60</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Which will return a confusion matrix.  You can see the &quot;most confused&quot; items by doing this:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> interp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">most_confused</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">min_val</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Bengal&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Egyptian_Mau&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;american_pit_bull_terrier&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;staffordshire_bull_terrier&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Ragdoll&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Birman&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;staffordshire_bull_terrier&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;american_pit_bull_terrier&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;american_pit_bull_terrier&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;american_bulldog&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="improving-the-model">Improving the model<a class="hash-link" href="#improving-the-model" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="learning-rate-finder">Learning Rate Finder<a class="hash-link" href="#learning-rate-finder" title="Direct link to heading">â€‹</a></h3><p>Start with a very, very small learning rate, something so small that we would never expect it to be too big to handle. We use that for one mini-batch, find what the losses are afterwards, and then increase the learning rate by some percentage (e.g., doubling it each time). Then we do another mini-batch, track the loss, and double the learning rate again. We keep doing this until the loss gets worse, instead of better. This is the point where we know we have gone too far. We then select a learning rate a bit lower than this point. Our advice is to pick either:</p><ul><li>One order of magnitude less than where the minimum loss was achieved (i.e., the minimum divided by 10)</li><li>The last point where the loss was clearly decreasing </li></ul><p>The learning rate finder computes those points and more on the curve to help you. Additional learning rate suggestion algorithms can be passed into the function, by default only the valley paradigm is used. The learning rate finder can be called with <code>learn.lr_find</code>:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> learn </span><span class="token operator">=</span><span class="token plain"> cnn_learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resnet34</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> metrics</span><span class="token operator">=</span><span class="token plain">error_rate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> lr_min</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lr_steep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lr_valley</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lr_slide </span><span class="token operator">=</span><span class="token plain"> learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lr_find</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">suggest_funcs</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">minimum</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> steep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> valley</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> slide</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><img loading="lazy" src="/assets/images/2022-03-05-13-18-01-fe546be7ea38a444f60e4ac6ea005d1b.png" width="1468" height="1014"></p><p>The default <code>valley</code> hueristic works just fine.  Note, you will want to re-run this anytime you change your model such as unfreeze layers.  You might want to run this periodically if you are checkpointing during training.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="fine-tuning-models">Fine Tuning models<a class="hash-link" href="#fine-tuning-models" title="Direct link to heading">â€‹</a></h3><p>When we create a model from a pretrained network fastai automatically freezes all of the pretrained layers for us. When we call the <code>fine_tune</code> method fastai does two things:</p><ul><li>Trains the randomly added layers for one epoch, with all other layers frozen</li><li>Unfreezes all of the layers, and trains them all for the number of epochs requested</li></ul><p>Although this is a reasonable default approach, it is likely that for your particular dataset you may get better results by doing things slightly differently. The <code>fine_tune</code> method has a number of parameters you can use to change its behavior, but it might be easiest for you to just call the underlying methods directly if you want to get some custom behavior.</p><p><code>fit_one_cycle</code> is the suggested way to train models without using <code>fine_tune</code>. We&#x27;ll see why later in the book; in short, what <code>fit_one_cycle</code> does is to start training at a low learning rate, gradually increase it for the first section of training, and then gradually decrease it again for the last section of training.</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn </span><span class="token operator">=</span><span class="token plain"> cnn_learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resnet34</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> metrics</span><span class="token operator">=</span><span class="token plain">error_rate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fit_one_cycle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">3e-3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># train the head</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">unfreeze</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># unfreeze everything</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">lr_find</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)"># find new lr after unfreezing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fit_one_cycle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lr_max</span><span class="token operator">=</span><span class="token number">1e-5</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">#fine tune it all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="discriminative-learning-rates">Discriminative Learning Rates<a class="hash-link" href="#discriminative-learning-rates" title="Direct link to heading">â€‹</a></h3><p>One important aspect of fine tuning is discriminative learning rates: use a lower learning rate for the early layers of the neural network, and a higher learning rate for the later layers (and especially the randomly added layers).</p><p>fastai lets you pass a Python <code>slice</code> object anywhere that a learning rate is expected. The first value passed will be the learning rate in the earliest layer of the neural network, and the second value will be the learning rate in the final layer. The layers in between will have learning rates that are multiplicatively equidistant throughout that range. Let&#x27;s use this approach to replicate the previous training, but this time we&#x27;ll only set the <em>lowest</em> layer of our net to a learning rate of 1e-6; the other layers will scale up to 1e-4. Let&#x27;s train for a while and see what happens:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn </span><span class="token operator">=</span><span class="token plain"> cnn_learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resnet34</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> metrics</span><span class="token operator">=</span><span class="token plain">error_rate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fit_one_cycle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">3e-3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">unfreeze</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fit_one_cycle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">12</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lr_max</span><span class="token operator">=</span><span class="token builtin" style="color:rgb(189, 147, 249)">slice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">1e-6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token number">1e-4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We can accomplish everything we did above by calling <code>fine_tune</code> instead.  <code>fine_tune</code> will automatically apply discriminative learning rates for you:</p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token plain"> learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fine_tune??</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Signature</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fine_tune</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    epochs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    base_lr</span><span class="token operator">=</span><span class="token number">0.002</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    freeze_epochs</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lr_mult</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pct_start</span><span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    div</span><span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    lr_max</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    div_final</span><span class="token operator">=</span><span class="token number">100000.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    wd</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    moms</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    cbs</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    reset_opt</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Source</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@patch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(248, 248, 242)">@delegates</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fit_one_cycle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">fine_tune</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">Learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> epochs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> base_lr</span><span class="token operator">=</span><span class="token number">2e-3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> freeze_epochs</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> lr_mult</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              pct_start</span><span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> div</span><span class="token operator">=</span><span class="token number">5.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Fine tune with `Learner.freeze` for `freeze_epochs`, then with `Learner.unfreeze` for `epochs`, using discriminative LR.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">freeze</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fit_one_cycle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">freeze_epochs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">slice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">base_lr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> pct_start</span><span class="token operator">=</span><span class="token number">0.99</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    base_lr </span><span class="token operator">/=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">unfreeze</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    self</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fit_one_cycle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">epochs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">slice</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">base_lr</span><span class="token operator">/</span><span class="token plain">lr_mult</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> base_lr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> pct_start</span><span class="token operator">=</span><span class="token plain">pct_start</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> div</span><span class="token operator">=</span><span class="token plain">div</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token operator">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">File</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">      </span><span class="token operator">~</span><span class="token operator">/</span><span class="token plain">anaconda3</span><span class="token operator">/</span><span class="token plain">lib</span><span class="token operator">/</span><span class="token plain">python3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token number">9</span><span class="token operator">/</span><span class="token plain">site</span><span class="token operator">-</span><span class="token plain">packages</span><span class="token operator">/</span><span class="token plain">fastai</span><span class="token operator">/</span><span class="token plain">callback</span><span class="token operator">/</span><span class="token plain">schedule</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">py</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">      method</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="mixed-precision-training">Mixed Precision Training<a class="hash-link" href="#mixed-precision-training" title="Direct link to heading">â€‹</a></h2><p>You can achieve mixed precision training to speed up training and give you more memory headroom for bigger models with <code>to_fp16()</code></p><div class="codeBlockContainer_I0IT language-python theme-code-block"><div class="codeBlockContent_wNvx python"><pre tabindex="0" class="prism-code language-python codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> fastai</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">callback</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fp16 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn </span><span class="token operator">=</span><span class="token plain"> cnn_learner</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dls</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resnet50</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> metrics</span><span class="token operator">=</span><span class="token plain">error_rate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">to_fp16</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">learn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">fine_tune</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> freeze_epochs</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note how you can use the <code>freeze_epochs</code> parameter to keep the base frozen for longer.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.dev/hamelsmu/notes/blob/master/docs/fastai/02_cv.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/fastai/fundamentals"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">1_Fundamentals</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/fastai/batch_predicitions"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Batch Predictions</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#data-prep" class="table-of-contents__link toc-highlight">Data Prep</a><ul><li><a href="#debugging" class="table-of-contents__link toc-highlight">Debugging</a></li><li><a href="#example-of-an-error-in-data-prep" class="table-of-contents__link toc-highlight">Example of an error in data prep</a></li></ul></li><li><a href="#interpretation" class="table-of-contents__link toc-highlight">Interpretation</a></li><li><a href="#improving-the-model" class="table-of-contents__link toc-highlight">Improving the model</a><ul><li><a href="#learning-rate-finder" class="table-of-contents__link toc-highlight">Learning Rate Finder</a></li><li><a href="#fine-tuning-models" class="table-of-contents__link toc-highlight">Fine Tuning models</a></li><li><a href="#discriminative-learning-rates" class="table-of-contents__link toc-highlight">Discriminative Learning Rates</a></li></ul></li><li><a href="#mixed-precision-training" class="table-of-contents__link toc-highlight">Mixed Precision Training</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Get In Touch</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/HamelHusain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://hamel.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">About Hamel</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Hamel Husain</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8d0bccbc.js"></script>
<script src="/assets/js/main.f7695f3c.js"></script>
</body>
</html>