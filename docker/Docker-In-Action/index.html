<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<link rel="search" type="application/opensearchdescription+xml" title="Hamel&#39;s Notes" href="/opensearch.xml"><title data-rh="true">Docker | Hamel&#x27;s Notes</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://notes.hamel.dev/docker/Docker-In-Action"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Docker | Hamel&#x27;s Notes"><meta data-rh="true" name="description" content="Notes from the book Docker In Action"><meta data-rh="true" property="og:description" content="Notes from the book Docker In Action"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://notes.hamel.dev/docker/Docker-In-Action"><link data-rh="true" rel="alternate" href="https://notes.hamel.dev/docker/Docker-In-Action" hreflang="en"><link data-rh="true" rel="alternate" href="https://notes.hamel.dev/docker/Docker-In-Action" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://N4X7RUH2CX-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.04cdaf53.css">
<link rel="preload" href="/assets/js/runtime~main.a4e3deaf.js" as="script">
<link rel="preload" href="/assets/js/main.48794cca.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Notes</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_Pssr toggle_TdHA toggleChecked_cnQY toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">🌜</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">🌞</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" checked="" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode (currently dark mode)"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Hamel&#x27;s Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/concurrency">Python Concurrency</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/actions/">actions</a><button aria-label="Toggle the collapsible sidebar category &#x27;actions&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docker/Docker-In-Action">docker</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docker/Docker-In-Action">Docker</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/how-to-learn/lhtl">how-to-learn</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/fastai/fundamentals">fastai</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/jupyter/remote_browser">jupyter</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/linux/">linux</a><button aria-label="Toggle the collapsible sidebar category &#x27;linux&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/programming-languages/pl">programming-languages</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">docker</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/docker/Docker-In-Action">Docker</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Docker</h1></header><p>Notes from the book <a href="https://www.manning.com/books/docker-in-action-second-edition?utm_source=google&amp;utm_medium=search&amp;utm_campaign=dynamicsearch&amp;gclid=CjwKCAjwmMX4BRAAEiwA-zM4JtyXLeFoALyh7xvEtg9B7nTbf3VeOFzo6Sdu119z94d6cll6XsbKgxoCRmMQAvD_BwE" target="_blank" rel="noopener noreferrer">Docker In Action</a></p><div class="tableOfContentsInline_gwOO"><ul class="table-of-contents"><li><a href="#injecting-environment-variables">Injecting environment variables</a></li><li><a href="#automatically-restarting-containers">Automatically restarting containers</a></li><li><a href="#removing-containers-vs-images">Removing containers vs. images</a></li><li><a href="#images-as-files">Images as files</a></li><li><a href="#different-kind-of-volumes">Different kind of Volumes</a></li><li><a href="#to-persist-data-with-named-volumes">To persist data with named volumes</a></li><li><a href="#see-where-docker-anonymous-volumes-store-information">See where Docker anonymous volumes store information</a></li><li><a href="#other-things-you-didnt-know-about-volumes">Other things you didn&#39;t know about volumes</a></li><li><a href="#the-volumes-from-flag">The <code>volumes-from</code> flag</a></li><li><a href="#cleaning-up-volumes">Cleaning up volumes</a></li><li><a href="#advanced-volume-stuff">Advanced Volume Stuff</a></li><li><a href="#exposing-ports">exposing ports</a></li><li><a href="#limit-resources-memory-cpu">Limit resources: Memory, CPU,</a></li><li><a href="#running-as-a-user">Running as a user</a></li><li><a href="#privileged-containers-try-not-to-do-this">Privileged Containers: TRY NOT TO DO THIS</a></li><li><a href="#recovering-changes-to-a-stopped-container">Recovering changes to a stopped container</a></li><li><a href="#seeing-changes-to-a-container-from-the-base-image">Seeing changes to a container from the base image</a></li><li><a href="#other-tricks">Other tricks</a></li><li><a href="#understanding-images--layers">Understanding Images &amp; Layers</a></li><li><a href="#entrypoint-something-arugment-vs-entrypoint-something-argument">ENTRYPOINT something arugment vs. ENTRYPOINT "something", "argument"</a></li><li><a href="#cmd-vs-entrypoint-you-should-really-try-to-always-use-both">CMD vs. ENTRYPOINT (You should really try to always use both!)</a></li><li><a href="#copy-vs-add">COPY vs ADD</a></li><li><a href="#onbuild">ONBUILD</a></li><li><a href="#other-stuff">Other Stuff</a></li><li><a href="#docker-digests">Docker Digests</a></li><li><a href="#scaling-up-wdocker-compose">Scaling Up w/Docker Compose</a></li><li><a href="#templating-docker-compose-files">Templating Docker Compose Files</a></li></ul></div>;<h1>Chapter 1</h1><ul><li>Docker containers are faster than VMs to start, partly because they do NOT offer any hardware virtualization.  <ul><li>VMs provide hardware abstractions so you can run operating systems.</li></ul></li><li>Docker uses Linux <code>namespaces</code> and <code>cgropus</code><ul><li>Hamel: I don&#x27;t know what this is</li></ul></li></ul><h1>Chapter 2</h1><ul><li><p>Getting help: </p><ul><li><code>docker help cp</code></li><li><code>docker help run</code></li></ul></li><li><p>Linking containers:  <code>docker run --link</code> </p><ul><li>this is <a href="https://docs.docker.com/network/links/" target="_blank" rel="noopener noreferrer">apparently deprecated</a> per the docs </li><li>Opens a secure tunnel between two containers automatically</li><li>Also exposes environment variables and other things (see the docs)</li></ul></li><li><p><code>docker cp</code>   copy files from a container to local filesystem</p></li><li><p>Detach an interactive container:</p><ul><li>Hold down <code>Control</code> and press <code>P</code> then <code>Q</code></li></ul></li><li><p>Get logs <code>docker logs &lt;container name&gt;</code></p><ul><li>Hamel: This is like <code>kubectl logs</code></li></ul></li><li><p>Run a new command in a running container <code>docker exec</code></p><ul><li><code>docker exec &lt;container_name&gt; ps</code> will run the <code>ps</code> command and emit that to stdout</li></ul></li><li><p>Rename a container with <code>docker rename &lt;current_name&gt; &lt;new_name&gt;</code></p></li><li><p><code>docker exec</code> run additional processes in an already running container</p></li><li><p><code>docker create</code> is the same as <code>docker run</code> except that the container is created in a stopped state.</p></li><li><p><code>docker run --read-only</code> allows you to run a container in a read only state, which you only need to do in special circumstances (you probably never need to use this).   You can make exceptions to the read only constraint with the <code>-v</code> flag:
</p></li></ul><p><img loading="lazy" src="/assets/images/6453FD28-1552-474C-9869-F6E01C6EC9C8-706bfb3e99e66cb1675ac5566ae9b732.png" width="1288" height="198"></p><ul><li>Override the entrypoint using the <code>--entrypoint</code> flag (this is discussed in part 2 of the book).
</li></ul><p><img loading="lazy" src="/assets/images/276CD61C-3D6F-485A-8D88-8C2DD2EF8B5D-32adc74c147b183c3ad6ab8988ea70c1.png" width="1344" height="180"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="injecting-environment-variables">Injecting environment variables<a class="hash-link" href="#injecting-environment-variables" title="Direct link to heading">​</a></h3><p>With the <code>--env</code> or <code>-e</code> flags.<br>
<!-- -->A nice trick to see all the environment variables in a docker container is to use the Unix command <code>env</code></p><p><img loading="lazy" src="/assets/images/2070CA60-7C95-4BE8-B2C8-F68FF6B09C66-c516be80b8d7bb77a5ff704989ac4253.png" width="1618" height="152"></p><p>Setting multiple environment variables: use <code>\</code> for multiline like this:</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> create </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --env </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">WORDPRESS_DB_HOST</span><span class="token operator">=</span><span class="token operator">&lt;</span><span class="token plain">my database hostname</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --env </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">WORDPRESS_DB_USER</span><span class="token operator">=</span><span class="token plain">site_admin </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  --env </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">WORDPRESS_DB_PASSWORD</span><span class="token operator">=</span><span class="token plain">MeowMix42 </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wordpress:4</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="automatically-restarting-containers">Automatically restarting containers<a class="hash-link" href="#automatically-restarting-containers" title="Direct link to heading">​</a></h3><p>Docker uses an exponential backoff strategy - double the previous time waiting until restarting.  </p><p><code>docker run -d --restart always ... </code></p><p>See <a href="https://docs.docker.com/engine/reference/run/#restart-policies---restart" target="_blank" rel="noopener noreferrer">these restart policies</a> </p><ul><li>no</li><li>on-failure<!-- -->[:max-retries]</li><li>always</li><li>unless-stopped</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="removing-containers-vs-images">Removing containers vs. images<a class="hash-link" href="#removing-containers-vs-images" title="Direct link to heading">​</a></h3><p><strong>Containers are the actual instantiation of an image</strong>, just like how an object is an instantion of an instance of a class.</p><p><code>docker rm</code>: remove a container
<code>docker rmi</code>: remove an image</p><h1>Chapter 3</h1><ul><li>Two ways to publish an image<ul><li>Build locally, push image to registry</li><li>Make a <code>Dockerfile</code> and use DockerHub&#x27;s build system.  <strong>This is preferred and considered to be safer, and DockerHub will mark your image as trusted if you do this</strong> because it is the only way to provide transparency to what is in your image. </li></ul></li><li>Search dockerhub by keyword , sorted descending by stars<ul><li><code>docker search &lt;keyword&gt;</code> </li><li>example:  <code>docker search postgres</code></li></ul></li><li>Using Alternative registries<ul><li><code>docker pull quay.io/dockerinaction/ch3_hello_registry:latest</code></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="images-as-files">Images as files<a class="hash-link" href="#images-as-files" title="Direct link to heading">​</a></h3><p>You can transport, save and load images as files!  (You don&#x27;t have to push them to a registry). </p><p><img loading="lazy" src="/assets/images/AD7BCDC9-8130-45AE-89A9-DE5410EE845B-a67034202420cca973fe51eb372bcc2c.png" width="1170" height="454"></p><p>You can then load the image:</p><p><code>docker load -i myfile.tar</code></p><h1>Chapter 4 Persistent Storage &amp;. Shared State with Volumes</h1><p><code>-v</code> and <code>--volume</code> are aliases</p><p><code>--volumes-from=&quot;&lt;container-name&gt;&quot;</code>  Mount all volumes from the given container</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="different-kind-of-volumes">Different kind of Volumes<a class="hash-link" href="#different-kind-of-volumes" title="Direct link to heading">​</a></h3><ol><li>Bind mount - this is what you always use</li><li>Docker managed volume (2 kinds)<ol><li>Anonymous</li><li>Named volume (a special case of Anonymous)</li></ol></li></ol><p><a href="https://docs.docker.com/storage/volumes/" target="_blank" rel="noopener noreferrer">Use volumes | Docker Documentation</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Named vs. Anonymous volumes: [article](https://medium.com/faun/what-are-anonymous-and-named-volumes-6cd787822a7d)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Hamel: maybe? You might use named volumes to persist data between containers.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="to-persist-data-with-named-volumes">To persist data with named volumes<a class="hash-link" href="#to-persist-data-with-named-volumes" title="Direct link to heading">​</a></h3><p>Named volume is a kind of anonymous volume where the mount point is managed by Docker.  Example of how you used a named volume:</p><ol><li><p>Start container with a <strong>named volume</strong>:
<code>docker run --name myDatabaseWithVolume -v appdata:/var/lib/mysql  mysql</code>
save a table in the mysql database</p></li><li><p>Start a new container with the same <strong>named volume</strong>
<code>docker run --name myDatabaseWithVolume2 -v appdata:/var/lib/mysql mysql</code>
You should be able to see the same table you created in the last container b/c data has been persisted.</p></li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="see-where-docker-anonymous-volumes-store-information">See where Docker anonymous volumes store information<a class="hash-link" href="#see-where-docker-anonymous-volumes-store-information" title="Direct link to heading">​</a></h3><p>Unlike a bind mount, where you explicitly name the host location, docker will manage the storage location of anonymous volumes.  But how do you know where the files are stored on the host?</p><p>You can use <code>docker inspect</code> command filtered for the <code>Volumes</code> key to find the storage location on the host. </p><p>Create a container with an anonymous volume.
<code>docker run -v /some/location --name cass-shared alpine</code></p><p><code>docker inspect -f &quot;{{json .Volumes}}&quot; cass-shared</code></p><p>This will output a json blob which will show the mount points.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="other-things-you-didnt-know-about-volumes">Other things you didn&#x27;t know about volumes<a class="hash-link" href="#other-things-you-didnt-know-about-volumes" title="Direct link to heading">​</a></h3><ul><li>when you mount a volume, it overrides any files already at that location<ul><li>You can mount specific files which avoid this</li><li>if you specify a host directory that doesn&#x27;t exist Docker will create it for you<ul><li>exception: If you are mounting a file instead of a directory and it doesn&#x27;t exist on the host, Docker will throw an error</li></ul></li></ul></li><li>you can mount a volume as read only  <code>-v /source:/destination:ro</code><ul><li>see docs (there is this optional third argument for volumes)</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="the-volumes-from-flag">The <code>volumes-from</code> flag<a class="hash-link" href="#the-volumes-from-flag" title="Direct link to heading">​</a></h3><p>Allows you to share volumes with another container.  When you use this flag, the same volumes are mounted into your container at the same location. </p><p><img loading="lazy" src="/assets/images/6B5A3266-48E5-4A8F-9051-651971AD8824-431c70f9bd69ff9568171a23b4c823dc.png" width="1048" height="440"></p><p>Volumes are copied transitively, so this will automatically mount volumes that are also mounted this way from another container. </p><p><strong>Caveats</strong></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">- You cannot mount a shared volume to a different location within a container.  This is a limitation of `--volumes-from`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- If you have a collision in the destination mount point among several `volumes-from` only one volume will survive, which you can ascertain from `docker inpsect`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        - see above for how to use `docker inspect`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- You cannot change the write permission of the volume, you inherit whatever the permission is in the source container.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="cleaning-up-volumes">Cleaning up volumes<a class="hash-link" href="#cleaning-up-volumes" title="Direct link to heading">​</a></h3><p><code>-v</code> flag</p><p><code>docker rm -v</code> will delete any managed volumes referenced by the target container</p><p>However, if you delete all containers but forget a <code>-v</code> flag you will be left with an <strong>orphaned volume</strong>.  This is bad b/c it takes up disk space until cleaned up.  You have to run complicated cleanup steps to get rid of orphans.</p><p>Solution:  There is none, <strong>its a good habit to use -v anytime you call docker rm</strong></p><p>Hamel: this means that- </p><ul><li>Don&#x27;t use managed volumes unless you really need it</li><li>If you do use them, try to include makefiles that include <code>-v</code> as a part of things </li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="advanced-volume-stuff">Advanced Volume Stuff<a class="hash-link" href="#advanced-volume-stuff" title="Direct link to heading">​</a></h3><ul><li>You can have a volume container p. 72 so that you can reference <code>--volume-from</code> from all your containers.  </li><li>Data-paced volume containers, you can pre-load volume containers with data p. 73</li><li>You can change the behavior of currently running containers by mounting configuration files and application in volumes.  In a way, Hamel</li></ul><h1>Chapter 5 Single Host Networking</h1><ul><li>Terminology:<ul><li>protocols: tcp, http</li><li>interfaces: IP addresses</li><li>ports:  you know what this means<ul><li>Customary ports:<ul><li>HTTP: 80</li><li>MySQL: 3306</li><li>Memcached: 11211</li></ul></li></ul></li></ul></li></ul><p>Discuss advanced networking and creating a network using the <code>docker network</code> command.  Hamel: I don&#x27;t see an immediate use for this.</p><ul><li>Special container networks:<ul><li><code>host</code><ul><li><code>docker run --network host</code> allows you to pretend like the host is your local machine, and you can expose any port and that will bind to the host. </li></ul></li><li><code>none</code><ul><li><code>docker run --network none</code> closes all connection to the outside world.  This is useful for security. </li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="exposing-ports">exposing ports<a class="hash-link" href="#exposing-ports" title="Direct link to heading">​</a></h3><p><code>-p 8080</code>
This binds port 8080 to a <strong>random</strong> port on the host!  you can find the port that the container is bound to by <code>docker port &lt;image name&gt;</code>
example:
<code>docker run -p 8080 --name listener alpine</code>
<code>docker port listener</code></p><p>This will give you output that looks like <code>container --&gt; host</code> (which is reverse the other nomenclature of <code>host:container</code></p><p><code> -p 8080:8080</code> this binds the container&#x27;s port to the host&#x27;s port 8080</p><p><code>-p 0.0.0.0:8080:8080/tcp</code> same as above but specifies the interface and the tcp protocol.  </p><p>Syntax is <code>-p &lt;host-interface&gt;:&lt;host-port&gt;:&lt;target-port&gt;/&lt;protocol&gt;</code></p><h1>Chapter 6 Isolation</h1><h3 class="anchor anchorWithStickyNavbar_mojV" id="limit-resources-memory-cpu">Limit resources: Memory, CPU,<a class="hash-link" href="#limit-resources-memory-cpu" title="Direct link to heading">​</a></h3><ul><li><code>-m</code> or <code>--memory</code> <ul><li>number, where unit = b, k, m or g</li><li>memory limits are not reservations, just caps</li></ul></li><li><code>--cpu-shares</code> <ul><li>is a weight you set that is used to calculate % of CPU usage allowed</li><li>% is calculated as weight / (sum of all weights)</li><li>only enforced when there is contention for a CPU</li></ul></li><li><code>--cpuset-cpus</code> : limits process to a specific CPU<ul><li><code>docker run -d --cpuset-cpus 0</code>  Restricts to CPU number 0</li><li>Can specify a list or <code>0,1,2</code> or a range <code>0-2</code></li></ul></li><li><code>--device</code><ul><li>mount your webcam:  <code>docker run --device /dev/video0:/dev/video0</code></li></ul></li><li>Shared memory : Hamel this was too advanced for me</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="running-as-a-user">Running as a user<a class="hash-link" href="#running-as-a-user" title="Direct link to heading">​</a></h3><ul><li><p>You can only inspect the default run-as User by creating or pulling the image</p><ul><li>see p. 113</li></ul></li><li><p>Change run-as user</p><ul><li><code>docker run --user nobody</code></li><li><strong>The user has to exist in the image when doing this or you will get an error</strong>.  The user will not be created automatically for you. </li><li>See available users:<ul><li><code>docker run --rm busybox:latest awk -F: &#x27;$0=$1&#x27; /etc/passwd</code></li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="privileged-containers-try-not-to-do-this">Privileged Containers: TRY NOT TO DO THIS<a class="hash-link" href="#privileged-containers-try-not-to-do-this" title="Direct link to heading">​</a></h3><ul><li>This is how you run Docker-in-Docker</li><li>Priviliged containers <strong>have root privileges on the host</strong>.  </li><li><code>--privilged</code> on <code>docker create</code> or <code>docker run</code></li></ul><h1>Chapter 7 packaging software</h1><p>Aside: cleaning up your docker environment	</p><p><code>docker image prune -a</code> and <code>docker container prune</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="recovering-changes-to-a-stopped-container">Recovering changes to a stopped container<a class="hash-link" href="#recovering-changes-to-a-stopped-container" title="Direct link to heading">​</a></h3><p>I always thought you have to commit changes in order to preserve changes to an image you made in a container.  This is not true (although committing changes is a good idea). </p><p><strong>Any changes you  make to a container is saved even if the container is exited</strong></p><p>To recover changes to a container</p><ol><li>Find the container (if you didn&#x27;t name it with <code>docker run --name</code> it will be named for you), using <code>docker ps -a</code></li><li>Start the container using <code>docker start -ai &lt;container_name&gt;</code>   the <code>-ai</code> flags mean to attach and run interactively</li><li>Now you are in the container you can verify that everything you installed is still there!</li></ol><p>Note: if you run your container initially with <code>docker run --rm</code> this automatically removes your container upon exit, so this might not be recommended as your changes are not recoverable if you forget to commit</p><p><img loading="lazy" src="/assets/images/D79BAEDA-4071-4040-8B7B-2B864588FA9E-9d5a6812358a70e104688814929c8edd.png" width="1496" height="264"></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="seeing-changes-to-a-container-from-the-base-image">Seeing changes to a container from the base image<a class="hash-link" href="#seeing-changes-to-a-container-from-the-base-image" title="Direct link to heading">​</a></h3><p><code>docker diff &lt;container name&gt;</code> will output a long list of of file changes:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - A: file added</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - D: file deleted</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - C: file changed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="other-tricks">Other tricks<a class="hash-link" href="#other-tricks" title="Direct link to heading">​</a></h3><p>You can override the entry point to the container <strong>permanently</strong> by using the <code>--entrypoint</code> flag:  <code>docker run --entrypoint</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="understanding-images--layers">Understanding Images &amp; Layers<a class="hash-link" href="#understanding-images--layers" title="Direct link to heading">​</a></h3><ul><li>files are stored in a Union file system, so they are stored in specific layers.  The file system you are seeing as an end user are a union of all the layers.  Each time a change is made to a union file system, that change is recorded on a new layer on top of all of the others. The “union” of all of those layers, or top-down view, is what the container (and user) sees when accessing the file system.<ul><li>This means <strong>if you are not careful you can bloat the file system by making a bunch of unnecessary changes to add/delete files.</strong></li></ul></li><li><code>docker commit</code> commits the top-layer changes to an image, meaning all the files changes are saved.</li></ul><p><strong>See image size with</strong></p><p><code>docker images</code>.  Even though you remove a file, the image size will increase!  This is because of the Union File System</p><p><strong>See size of all layers</strong></p><p><code>docker history &lt;image name&gt;</code></p><p><strong>flatten an image</strong> This is kind of complicated, you can do this by exporting and importing the filesystem into a base image See pg. 140.  BUT there is an experimental feature called <code>docker build --squash -t &lt;image&gt; .</code>You can enable experimental features by following these instructions: <a href="https://docs.docker.com/engine/reference/commandline/dockerd/#description" target="_blank" rel="noopener noreferrer">dockerd Docker Documentation</a>. For Mac, you can turn on experimental features by setting <code>experimental: true</code> in `settings&gt; Command Line &gt; enable experimental</p><h1>Chapter 8 Build Automation</h1><ul><li>use <code>.dockerignore</code> to prevent certain files from being copied</li><li>You can set multiple environment variables at once in Dockerfile</li><li>You can use environment variables in the <code>LABEL</code> command<ul><li>The metadata makes it clear that the environment variable substitution works. You can use this form of substitution in the ENV, ADD, COPY, WORKDIR, VOLUME, EXPOSE, and USER instructions.</li></ul></li></ul><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ENV APPROOT &quot;/app&quot; APP &quot;mailer.sh&quot; VERSION &quot;0.6&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">LABEL base.name &quot;Mailer Archetype&quot; base.version &quot;${VERSION}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>view metadata using the command <code>docker inspect &lt;image name&gt;</code></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="entrypoint-something-arugment-vs-entrypoint-something-argument">ENTRYPOINT something arugment vs. ENTRYPOINT <!-- -->[&quot;something&quot;, &quot;argument&quot;]<a class="hash-link" href="#entrypoint-something-arugment-vs-entrypoint-something-argument" title="Direct link to heading">​</a></h3><p><strong>TLDR; use the ugly list approach</strong></p><p>There are two instruction forms <strong>shell form</strong> and <strong>exec form</strong> <a href="https://stackoverflow.com/questions/42805750/dockerfile-cmd-shell-versus-exec-form" target="_blank" rel="noopener noreferrer">docker - Dockerfile CMD shell versus exec form - Stack Overflow</a></p><p>The ENTRYPOINT instruction has two forms: the shell form and an exec form. The shell form looks like a shell command with whitespace-delimited arguments. The exec form is a string array where the first value is the command to execute and the remaining values are arguments. .</p><p><strong>Most importantly, if the shell form is used for ENTRYPOINT, then all other arguments provided by the CMD instruction or at runtime as extra arguments to docker run will be ignored. This makes the shell form of ENTRYPOINT less flexible.</strong></p><p>Other commands can use the <strong>exec form</strong> too!  You must use the exec form when any of the arguments contain a whitespace:</p><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM dockerinaction/mailer-base:0.6 </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">COPY [&quot;./log-impl&quot;, &quot;${APPROOT}&quot;] </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RUN chmod a+x ${APPROOT}/${APP} &amp;&amp; \ chown example:example /var/log </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">USER example:example </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">VOLUME [&quot;/var/log&quot;]  # each value in this array will be created as a new volume definition</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CMD [&quot;/var/log/mailer.log&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note: you usually don&#x27;t want to specify a volume at build time.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="cmd-vs-entrypoint-you-should-really-try-to-always-use-both">CMD vs. ENTRYPOINT (You should really try to always use both!)<a class="hash-link" href="#cmd-vs-entrypoint-you-should-really-try-to-always-use-both" title="Direct link to heading">​</a></h3><p>CMD is actually an argument list for the <code>ENTRYPOINT</code>.  </p><ul><li>Logically when you run a container it runs as <code>&lt;default shell program&gt; ENTRYPOINT CMD</code></li><li>You can override the <code>ENTRYPOINT</code> with <code>docker run --entrypoint</code>, and you can override commands by just passing commands to docker run :  <code>docker run &lt;image name&gt; &lt;command&gt;</code></li></ul><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM ubuntu</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ENTRYPOINT [ &quot;ls&quot; ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CMD [&quot;-lah&quot;]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>As you can see using ENTRYPOINT as well as CMD separately provides your downstream users with the most flexibility.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="copy-vs-add">COPY vs ADD<a class="hash-link" href="#copy-vs-add" title="Direct link to heading">​</a></h3><p>Use COPY.  ADD has additional functionality like ability to download from urls and decompress files, which proved opaque over time and you shouldn&#x27;t use it.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="onbuild">ONBUILD<a class="hash-link" href="#onbuild" title="Direct link to heading">​</a></h3><p>The ONBUILD instruction defines instructions to execute if the resulting image is used as a base for another build.  those ONBUILD instructions are executed after the FROM instruction and before the next instruction in a Dockerfile.</p><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM busybox:latest </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">WORKDIR /app RUN touch /app/base-evidence </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ONBUILD RUN ls -al /app</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="other-stuff">Other Stuff<a class="hash-link" href="#other-stuff" title="Direct link to heading">​</a></h3><ul><li>You should always validate the presence of required environment variables in a startup shell script like <code>entrypoint.sh</code></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="docker-digests">Docker Digests<a class="hash-link" href="#docker-digests" title="Direct link to heading">​</a></h3><p>Reference the exact SHA of a Container which is the only way to guarantee the image you are referencing has not changed.   @ symbol followed by the digest. </p><p>Hamel: doesn&#x27;t look like a good way to find history of digests, but you can see the current SHA when you use <code>docker pull</code> , you can see the SHA as well if you call <code>docker images --digests</code></p><div class="codeBlockContainer_I0IT language-docker theme-code-block"><div class="codeBlockContent_wNvx docker"><pre tabindex="0" class="prism-code language-docker codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM debian@sha256:d5e87cfcb730...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h1>Chapter 10 (skipped Ch 9)</h1><ul><li>You can run your own customized registry.  Simplest version can be hosted from a Docker Container!</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># start a local registry on port 5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> run -d --name personal_registry</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"> -p </span><span class="token number">5000</span><span class="token plain">:5000 --restart</span><span class="token operator">=</span><span class="token plain">always </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain"> registry:2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># push an image to the registry (using the same image that created the registry for convenience)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> tag registry:2 localhost:5000/distribution:2 </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> push localhost:5000/distribution:2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that <code>docker push</code> syntax is actually <code>docker push &lt;registry url&gt;/org/repo</code></p><p>This chapter discusses many more things which are skipped:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Centralized registries</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Enhancements</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Durable blog storage</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Integrating through notifications</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h1>Chapter 11 Docker Compose</h1><p>Docker compose for fastpages:</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;3&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">fastpages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">&amp;fastpages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">working_dir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> INPUT_BOOL_SAVE_MARKDOWN=false</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./_action_files</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">dockerfile</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./Dockerfile</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> fastpages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">dev</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">logging</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">driver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">file</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">max-size</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 50m</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">stdin_open</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">tty</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> .</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/data/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">converter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">&lt;&lt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">*fastpages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /fastpages/action_entrypoint.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">watcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">&lt;&lt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token important">*fastpages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> watchmedo shell</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">command </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">command /fastpages/action_entrypoint.sh </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">pattern </span><span class="token important">*.ipynb</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">recursive </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">jekyll</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">working_dir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> hamelsmu/fastpages</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">jekyll</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">stopped</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;4000:4000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> .</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/data/</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">     bash -c &quot;gem install bundler</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">     &amp;&amp; jekyll serve --trace --strict_front_matter&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The above uses YAML anchors: <a href="https://confluence.atlassian.com/bitbucket/yaml-anchors-960154027.html" target="_blank" rel="noopener noreferrer">YAML anchors - Atlassian Documentation</a></p><p>Start a particular service: <code>docker-compose up &lt;service name&gt;</code>
Rebuild a service <code>docker-compose build &lt;service name&gt;</code></p><p>You can express dependencies with <code>depends_on</code> which is useful for compose to know which services to restart or start in a specified order. </p><p>See examples of Docker Compose files on p 243</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="scaling-up-wdocker-compose">Scaling Up w/Docker Compose<a class="hash-link" href="#scaling-up-wdocker-compose" title="Direct link to heading">​</a></h3><p>That&#x27;s right you don&#x27;t need docker swarm.  This example uses <a href="https://github.com/dockerinaction/ch11_coffee_api/blob/master/docker-compose.yml" target="_blank" rel="noopener noreferrer">ch11_coffee_api/docker-compose.yml at master · dockerinaction/ch11_coffee_api · GitHub</a></p><ol><li>Get  list of containers that are currently providing the service.  </li></ol><p><code>docker-compose ps coffee</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">          Name                 Command       State            Ports</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ch11_coffee_api_coffee_1   ./entrypoint.sh   Up      0.0.0.0:32768-&gt;3000/tcp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="2"><li>Scale it up with <code>docker-compose up --scale</code></li></ol><p><code>docker-compose up --scale coffee=5</code></p><p>When you run <code>docker-compose ps coffee</code>: </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">docker-compose ps coffee                                                                                                                         ✔</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          Name                 Command       State            Ports</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">----------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ch11_coffee_api_coffee_1   ./entrypoint.sh   Up      0.0.0.0:32768-&gt;3000/tcp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ch11_coffee_api_coffee_2   ./entrypoint.sh   Up      0.0.0.0:32769-&gt;3000/tcp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ch11_coffee_api_coffee_3   ./entrypoint.sh   Up      0.0.0.0:32771-&gt;3000/tcp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ch11_coffee_api_coffee_4   ./entrypoint.sh   Up      0.0.0.0:32770-&gt;3000/tcp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ch11_coffee_api_coffee_5   ./entrypoint.sh   Up      0.0.0.0:32772-&gt;3000/tcp</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that the coffee service binds to port <code>0</code> on your host, which is an <strong>ephemeral port</strong>, which just means that your host machine assigns the service to a random port.  This is required if you plan on using <code>docker compose up --scale</code></p><p>The service was bound to port 0 on the host with </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">coffee</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./coffee</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">user</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 777</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">777</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">expose</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token number">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;0:3000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ol start="3"><li>Load balancer</li></ol><p>Problem with this kind of scaling is you don&#x27;t know the ports in advance , and you don&#x27;t want to hit these individual endpoints, you need a load balancer.  This <a href="https://pspdfkit.com/blog/2018/how-to-use-docker-compose-to-run-multiple-instances-of-a-service-in-development/#adding-a-load-balancer" target="_blank" rel="noopener noreferrer">blog post</a> shows you how to luse NGINX as a load balancer.</p><p>You will need something like this in your compose file</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">nginx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> ./nginx.conf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">/etc/nginx/nginx.conf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">ro</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> pspdfkit</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;4000:4000&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="templating-docker-compose-files">Templating Docker Compose Files<a class="hash-link" href="#templating-docker-compose-files" title="Direct link to heading">​</a></h3><p>You can read about this here: <a href="https://docs.docker.com/compose/extends/" target="_blank" rel="noopener noreferrer">Share Compose configurations between files and projects | Docker Documentation</a>, allows you to override certain things from a base compose file. </p><h1>Chapter 12 Clusters w/Machine &amp; Swarm</h1><p>Hamel: I skipped this completely</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.dev/hamelsmu/notes/blob/master/docs/docker/Docker-In-Action.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/actions/resources"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Resources</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/how-to-learn/lhtl"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How To Learn</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#injecting-environment-variables" class="table-of-contents__link toc-highlight">Injecting environment variables</a></li><li><a href="#automatically-restarting-containers" class="table-of-contents__link toc-highlight">Automatically restarting containers</a></li><li><a href="#removing-containers-vs-images" class="table-of-contents__link toc-highlight">Removing containers vs. images</a></li><li><a href="#images-as-files" class="table-of-contents__link toc-highlight">Images as files</a></li><li><a href="#different-kind-of-volumes" class="table-of-contents__link toc-highlight">Different kind of Volumes</a></li><li><a href="#to-persist-data-with-named-volumes" class="table-of-contents__link toc-highlight">To persist data with named volumes</a></li><li><a href="#see-where-docker-anonymous-volumes-store-information" class="table-of-contents__link toc-highlight">See where Docker anonymous volumes store information</a></li><li><a href="#other-things-you-didnt-know-about-volumes" class="table-of-contents__link toc-highlight">Other things you didn&#39;t know about volumes</a></li><li><a href="#the-volumes-from-flag" class="table-of-contents__link toc-highlight">The <code>volumes-from</code> flag</a></li><li><a href="#cleaning-up-volumes" class="table-of-contents__link toc-highlight">Cleaning up volumes</a></li><li><a href="#advanced-volume-stuff" class="table-of-contents__link toc-highlight">Advanced Volume Stuff</a></li><li><a href="#exposing-ports" class="table-of-contents__link toc-highlight">exposing ports</a></li><li><a href="#limit-resources-memory-cpu" class="table-of-contents__link toc-highlight">Limit resources: Memory, CPU,</a></li><li><a href="#running-as-a-user" class="table-of-contents__link toc-highlight">Running as a user</a></li><li><a href="#privileged-containers-try-not-to-do-this" class="table-of-contents__link toc-highlight">Privileged Containers: TRY NOT TO DO THIS</a></li><li><a href="#recovering-changes-to-a-stopped-container" class="table-of-contents__link toc-highlight">Recovering changes to a stopped container</a></li><li><a href="#seeing-changes-to-a-container-from-the-base-image" class="table-of-contents__link toc-highlight">Seeing changes to a container from the base image</a></li><li><a href="#other-tricks" class="table-of-contents__link toc-highlight">Other tricks</a></li><li><a href="#understanding-images--layers" class="table-of-contents__link toc-highlight">Understanding Images &amp; Layers</a></li><li><a href="#entrypoint-something-arugment-vs-entrypoint-something-argument" class="table-of-contents__link toc-highlight">ENTRYPOINT something arugment vs. ENTRYPOINT "something", "argument"</a></li><li><a href="#cmd-vs-entrypoint-you-should-really-try-to-always-use-both" class="table-of-contents__link toc-highlight">CMD vs. ENTRYPOINT (You should really try to always use both!)</a></li><li><a href="#copy-vs-add" class="table-of-contents__link toc-highlight">COPY vs ADD</a></li><li><a href="#onbuild" class="table-of-contents__link toc-highlight">ONBUILD</a></li><li><a href="#other-stuff" class="table-of-contents__link toc-highlight">Other Stuff</a></li><li><a href="#docker-digests" class="table-of-contents__link toc-highlight">Docker Digests</a></li><li><a href="#scaling-up-wdocker-compose" class="table-of-contents__link toc-highlight">Scaling Up w/Docker Compose</a></li><li><a href="#templating-docker-compose-files" class="table-of-contents__link toc-highlight">Templating Docker Compose Files</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Get In Touch</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/HamelHusain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://hamel.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">About Hamel</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Hamel Husain</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a4e3deaf.js"></script>
<script src="/assets/js/main.48794cca.js"></script>
</body>
</html>