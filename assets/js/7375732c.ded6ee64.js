"use strict";(self.webpackChunknotes=self.webpackChunknotes||[]).push([[8084],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=o.createContext({}),u=function(e){var t=o.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return o.createElement(i.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},b=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),b=r,h=p["".concat(i,".").concat(b)]||p[b]||d[b]||a;return n?o.createElement(h,l(l({ref:t},c),{},{components:n})):o.createElement(h,l({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=b;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[p]="string"==typeof e?e:r,l[1]=s;for(var u=2;u<a;u++)l[u]=n[u];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}b.displayName="MDXCreateElement"},4443:function(e,t,n){n.r(t),n.d(t,{assets:function(){return i},contentTitle:function(){return l},default:function(){return p},frontMatter:function(){return a},metadata:function(){return s},toc:function(){return u}});var o=n(3117),r=(n(7294),n(3905));const a={},l="Jobs",s={unversionedId:"k8s/Jobs and CronJobs",id:"k8s/Jobs and CronJobs",title:"Jobs",description:"Thes are useful!  You can run ad-hoc jobs to completion, or schedule something to run!  Lots of DS workloads are like this.",source:"@site/docs/k8s/13-Jobs and CronJobs.md",sourceDirName:"k8s",slug:"/k8s/Jobs and CronJobs",permalink:"/k8s/Jobs and CronJobs",draft:!1,editUrl:"https://github.dev/hamelsmu/notes/blob/master/docs/k8s/13-Jobs and CronJobs.md",tags:[],version:"current",sidebarPosition:13,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"StatefulSet",permalink:"/k8s/StatefulSet"},next:{title:"Rollouts",permalink:"/k8s/Rollouts & Rollbacks"}},i={},u=[{value:"See Logs",id:"see-logs",level:2},{value:"Fields",id:"fields",level:2},{value:"Optional Fields",id:"optional-fields",level:3},{value:"Processing A Queue (Like data)",id:"processing-a-queue-like-data",level:3},{value:"CronJob Cleanup",id:"cronjob-cleanup",level:2},{value:"Pausing CronJobs",id:"pausing-cronjobs",level:2}],c={toc:u};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"jobs"},"Jobs"),(0,r.kt)("p",null,"Thes are useful!  You can run ad-hoc jobs to completion, or schedule something to run!  Lots of DS workloads are like this."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Jobs aren\u2019t just for stateful apps; they\u2019re a great way to bring a standard approach to any batch-processing problems, where you can hand off all the scheduling and monitoring and retry logic to the cluster.  You can run any container image in the Pod for a Job, but it should start a process that ends; otherwise, your jobs will keep running forever.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: batch/v1\nkind: Job                           # Job is the object type.\nmetadata:\n name: pi-job\nspec:\n template:\n   spec:                           # The standard Pod spec\n     containers:\n       - name: pi                  # The container should run and exit.\n         image: kiamol/ch05-pi     \n         command: ["dotnet", "Pi.Web.dll", "-m", "console", "-dp", "50"]\n     restartPolicy: Never          # If the container fails, replace the Pod.\n')),(0,r.kt)("h2",{id:"see-logs"},"See Logs"),(0,r.kt)("p",null,"Run the above and get logs"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kl apply -f pi/pi-job.yaml  # this is the filename  for the above\nkl logs jobs/pi-job\n")),(0,r.kt)("h2",{id:"fields"},"Fields"),(0,r.kt)("p",null,"its like a Pod standard spec, but there is an additional required field ",(0,r.kt)("inlineCode",{parentName:"p"},"restartPolicy"),"."),(0,r.kt)("h3",{id:"optional-fields"},"Optional Fields"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"completions:"),"  how many times should the job run. "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"parallelism"),":  How many Pods to run in parallel with multiple completions set.  ")),(0,r.kt)("h3",{id:"processing-a-queue-like-data"},"Processing A Queue (Like data)"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Parallel Jobs with a work queue:"),(0,r.kt)("ul",{parentName:"blockquote"},(0,r.kt)("li",{parentName:"ul"},"do not specify .spec.completions, default to .spec.parallelism."),(0,r.kt)("li",{parentName:"ul"},"the Pods must coordinate amongst themselves or an external service to determine what each should work on. For example, a Pod might fetch a batch of up to N items from the work queue."),(0,r.kt)("li",{parentName:"ul"},"each Pod is independently capable of determining whether or not all its peers are done, and thus that the entire Job is done."),(0,r.kt)("li",{parentName:"ul"},"when any Pod from the Job terminates with success, no new Pods are created."),(0,r.kt)("li",{parentName:"ul"},"once at least one Pod has terminated with success and all Pods are terminated, then the Job is completed with success."),(0,r.kt)("li",{parentName:"ul"},"once any Pod has exited with success, no other Pod should still be doing any work for this task or writing any output. They should all be in the process of exiting."))),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/job/"},"https://kubernetes.io/docs/concepts/workloads/controllers/job/")),(0,r.kt)("p",null,"Argo is basically a wrapper on Jobs. "),(0,r.kt)("h1",{id:"cronjob"},"CronJob"),(0,r.kt)("p",null,"Just adds a few lines to the Job YAML:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n name: todo-db-backup\nspec:\n schedule: "*/2 * * * *"          # Creates a Job every 2 minutes\n concurrencyPolicy: Forbid        # Prevents overlap so a new Job won\u2019t be\n jobTemplate:                     # created if the previous one is running\n   spec:\n     # job template...\n')),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#cronjobspec-v1-batch"},"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#cronjobspec-v1-batch")),(0,r.kt)("h2",{id:"cronjob-cleanup"},"CronJob Cleanup"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"CronJobs don\u2019t perform an automatic cleanup for Pods and Jobs.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"CronJobs don\u2019t follow the standard controller model, with a label selector to identify the Jobs it owns. You can add your own labels in the Job template for the CronJob, but if you don\u2019t do that, you need to identify Jobs where the owner reference is the CronJob")))),(0,r.kt)("p",null,"TLDR; Clean up lingering pods afer you are done, and organize everything with labels!"),(0,r.kt)("h2",{id:"pausing-cronjobs"},"Pausing CronJobs"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"You can also move CronJobs to a suspended state, which means the object spec still exists in the cluster, but it doesn\u2019t run until the CronJob is activated again"),(0,r.kt)("li",{parentName:"ul"})))}p.isMDXComponent=!0}}]);